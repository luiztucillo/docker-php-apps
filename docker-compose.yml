version: '2'
services:
  nginx:
    build:
      context: images/nginx
      args:
        username: ${USERNAME}
        domain: ${DOMAIN}
    container_name: ${APPLICATION}_nginx
    ports:
      - 80:80
      - 443:443
    links:
      - php
    volumes:
      - ${HOST_APP_PATH}:/var/www/html:delegated
      - ./data/log:/var/log/nginx
      - ./images/nginx/conf/ssl/:/etc/nginx/ssl/
      - ./images/nginx/conf/conf.d/default.conf:/etc/nginx/conf.d/default.conf
      - ./images/nginx/conf/applications/${APPLICATION}.conf:/etc/nginx/application.conf
      - ./images/nginx/conf/includes:/etc/nginx/includes
    networks:
      mynetwork:
        aliases:
          - ${DOMAIN}

  php:
    build:
      context: images/php
      dockerfile: Dockerfile-${PHP_VERSION}
      args:
        username: ${USERNAME}
        host_os: ${HOST_OS}
    container_name: ${APPLICATION}_php
    links:
      - redis
      - agensgraph
    volumes:
      - ${HOST_APP_PATH}:/var/www/html:cached
      - /private:/private:delegated #/tmp dir for mac
      - ./data/log:/var/log/php-fpm:delegated
      - ./data/log/xdebug:/var/log/xdebug:delegated
      - ./data/composer:/home/${USERNAME}/.composer:delegated
    networks:
      - mynetwork
    environment:
      - WP_CORE_DIR=/var/www/html
      - WP_TESTS_DIR=/var/www/html/tests
      - PHP_IDE_CONFIG="serverName=Docker"

  agensgraph:
    image: bitnine/agensgraph:v2.1.1
    container_name: ${APPLICATION}_agensgraph
    command: tail -F /dev/null
    volumes:
      - agensgraph:/home/agens/AgensGraph/data
    ports:
      - 5432:5432
    networks:
      - mynetwork

  agensbrowser:
    build:
      context: images/agensbrowser
    container_name: ${APPLICATION}_agensbrowser
    command: tail -F /dev/nul
    depends_on:
      - agensgraph
    volumes:
      - ./images/agensbrowser/agens-browser.config.yml:/home/agens/AgensBrowser/agens-browser.config.yml
    ports:
      - 8085:8085
    networks:
      - mynetwork

  mailhog:
    image: mailhog/mailhog
    container_name: ${APPLICATION}_mailhog
    ports:
      - 1025:1025
      - 8025:8025
    networks:
      - mynetwork

  redis:
    image: redis:4.0
    container_name: ${APPLICATION}_redis
    ports:
      - 6379:6379
    networks:
      - mynetwork

  redismin:
    image: redsmin/proxy
    container_name: ${APPLICATION}_redismin
    environment:
      REDSMIN_KEY: ${REDISMIN_KEY}
      REDIS_URI: redis://redis:6379
    networks:
      - mynetwork

networks:
  mynetwork:
    driver: bridge

volumes:
  agensgraph:
